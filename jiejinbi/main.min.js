var GameScene=function(t){function e(){t.call(this),this.factor=30,this.bricks=[],this.bricksShape=[],this.bricksBody=[],this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e),r=i.prototype;return r.onAddToStage=function(t){this.stageW=this.stage.stageWidth,this.stageH=this.stage.stageHeight,this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this),this.createBg(),this.createWorld(),this.createPaddle(),this.createBall(),this.createBrick(),this.createMaterial(),this.createDebugDraw(),this.hitListener(),this.touchEnabled=!0,this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.startGame,this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.beginMovePaddle,this),this.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.movePaddle,this),this.addEventListener(egret.Event.ENTER_FRAME,this.viewUpdate,this)},r.createBg=function(){var t=new egret.Shape;t.graphics.beginFill(4551490),t.graphics.drawRect(0,0,this.stageW,this.stageH),t.graphics.endFill(),this.addChild(t)},r.createWorld=function(){var t=new p2.World({gravity:[0,0]});this.world=t;var e=new p2.Box({width:this.stageW/this.factor,height:10/this.factor}),i=new p2.Body({position:[this.stageW/2/this.factor,0],mass:1});i.type=p2.Body.STATIC,i.addShape(e),this.world.addBody(i),this.wallTopShape=e;var r=new p2.Box({width:10/this.factor,height:this.stageH/this.factor}),a=new p2.Body({position:[0,this.stageH/2/this.factor],mass:1});a.type=p2.Body.STATIC,a.addShape(r),this.world.addBody(a),this.wallLeftShape=r;var o=new p2.Box({width:10/this.factor,height:this.stageH/this.factor}),s=new p2.Body({position:[this.stageW/this.factor,this.stageH/2/this.factor],mass:1});s.type=p2.Body.STATIC,s.addShape(o),this.world.addBody(s),this.wallRightShape=o},r.createPaddle=function(){var t=new egret.Bitmap(RES.getRes("paddle_png")),e=t.width,i=t.height;this.addChild(t);var r=new p2.Box({width:e/this.factor,height:i/this.factor}),a=new p2.Body({position:[this.stageW/2/this.factor,(this.stageH-30)/this.factor],mass:1});a.type=p2.Body.STATIC,a.addShape(r),this.world.addBody(a),this.paddle=t,this.paddleShape=r,this.paddleBody=a},r.createBall=function(){var t=new egret.Bitmap(RES.getRes("ball_png")),e=(t.width,t.height,t.width/2);this.addChild(t);var i=new p2.Circle({radius:e/this.factor}),r=new p2.Body({position:[this.stageW/2/this.factor,this.paddleBody.position[1]-14/this.factor],mass:1});r.damping=0,r.type=p2.Body.DYNAMIC,r.addShape(i),this.world.addBody(r),this.ballOnPaddle=!0,this.ball=t,this.ballShape=i,this.ballBody=r},r.createBrick=function(){for(var t=0;3>t;t++)for(var e=0;15>e;e++){var i=new egret.Bitmap(RES.getRes("brick"+t+"_png")),r=i.width,a=i.height,o=new p2.Box({width:r/this.factor,height:a/this.factor}),s=new p2.Body({position:[(180+42*e)/this.factor,(100+80*t)/this.factor]});s.type=p2.Body.STATIC,s.addShape(o),this.world.addBody(s),this.addChild(i),i.x=s.position[0]*this.factor-r/2,i.y=s.position[1]*this.factor-a/2,this.bricks.push(i),this.bricksShape.push(o),this.bricksBody.push(s)}},r.createMaterial=function(){var t=new p2.Material,e=new p2.Material,i=new p2.ContactMaterial(t,e);i.restitution=1,i.friction=0,this.paddleShape.material=t,this.wallTopShape.material=t,this.wallLeftShape.material=t,this.wallRightShape.material=t,this.ballShape.material=e;for(var r=0;r<this.bricksShape.length;r++){var a=this.bricksShape[r];a.material=t}this.world.addContactMaterial(i)},r.createDebugDraw=function(){this.debugSprite=new egret.Sprite,this.addChild(this.debugSprite),this.debugDraw=new p2DebugDraw(this.world,this.debugSprite)},r.beginMovePaddle=function(t){this.lastX=t.stageX},r.movePaddle=function(t){var e=t.stageX-this.lastX;this.paddleBody.position[0]+=e/this.factor,this.lastX=t.stageX},r.startGame=function(t){if(this.ballOnPaddle){var e=Math.floor(5*Math.random()+5);this.ballBody.velocity=[e,-15],this.ballOnPaddle=!1}},r.hitListener=function(){var t=this;this.world.on("endContact",function(e){for(var i=0;i<t.bricksBody.length;i++){var r=t.bricksBody[i];e.bodyA===r||e.bodyB===r?(t.world.removeBody(r),t.removeChild(t.bricks[i])):(e.bodyA===t.paddleBody||e.bodyB===t.paddleBody)&&(t.ballBody.position[0]>t.paddleBody.position[0]?t.ballBody.velocity=[Math.floor(5*Math.random()+5),-15]:t.ballBody.velocity=[-Math.floor(5*Math.random()+5),-15])}})},r.viewUpdate=function(t){this.world.step(1/60),this.ballBody.velocity[2]>-13&&(this.ballBody.velocity[2]=-15),this.ballOnPaddle&&(this.ballBody.position[0]=this.paddleBody.position[0]),this.ballBody.position[1]>this.stageH/this.factor&&(this.ballBody.position[1]=this.paddleBody.position[1]-14/this.factor,this.ballBody.velocity=[0,0],this.ballOnPaddle=!0),this.paddle.x=this.paddleBody.position[0]*this.factor-this.paddle.width/2,this.paddle.y=this.paddleBody.position[1]*this.factor-this.paddle.height/2,this.ball.x=this.ballBody.position[0]*this.factor-this.ball.width/2,this.ball.y=this.ballBody.position[1]*this.factor-this.ball.width/2},e}(egret.DisplayObjectContainer);egret.registerClass(GameScene,"GameScene");var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e),r=i.prototype;return r.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},r.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e),r=i.prototype;return r.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},r.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},r.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},r.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},r.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},r.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},r.createGameScene=function(){this.addChild(new GameScene)},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var p2DebugDraw=function(){function t(t,e){this.COLOR_D_SLEEP=10066329,this.COLOR_D_WAKE=15053490,this.COLOR_K=8355813,this.COLOR_S=8381823,this.COLOR_BLACK=0,this.COLOR_RED=16711680,this.isDrawAABB=!1,this.factor=30,this.world=t,this.sprite=e}var e=(__define,t),i=e.prototype;return i.drawDebug=function(){this.sprite.graphics.clear();for(var t=this.world.bodies.length,e=0;t>e;e++)for(var i=this.world.bodies[e],r=0;r<i.shapes.length;r++){var a=i.shapes[r];this.drawShape(a,i),this.isDrawAABB&&this.drawAABB(i)}t=this.world.constraints.length;for(var o,r=0;t>r;r++)switch(o=this.world.constraints[r],o.type){case p2.Constraint.DISTANCE:this.drawDistanceJoint(o);break;case p2.Constraint.REVOLUTE:this.drawRevoluteJoint(o);break;case p2.Constraint.GEAR:this.drawGearJoint(o);break;case p2.Constraint.PRISMATIC:this.drawPrismaticJoint(o);break;case p2.Constraint.LOCK:this.drawLockJoint(o)}t=this.world.springs.length;for(var s,n=0;t>n;n++)s=this.world.springs[n],s instanceof p2.LinearSpring?this.drawLinearSpring(s):s instanceof p2.RotationalSpring&&this.drawRotationalSpring(s)},i.drawAABB=function(t){var e=new Array,i=t.aabb.lowerBound[0],r=t.aabb.lowerBound[1],a=t.aabb.upperBound[0],o=t.aabb.upperBound[1];isFinite(i)&&isFinite(r)&&isFinite(a)&&isFinite(o)&&(e.push([i,r],[a,r],[a,o],[i,o]),this.drawConvex(e,this.COLOR_S,1,!1))},i.drawDistanceJoint=function(t){var e,i=new Array,r=new Array;e=t.distance,t.upperLimitEnabled&&t.upperLimit>e&&(e=t.upperLimit),t.bodyA.toWorldFrame(i,t.localAnchorA),t.bodyB.toWorldFrame(r,t.localAnchorB);var a=p2.vec2.subtract([],r,i);p2.vec2.normalize(a,a),p2.vec2.scale(a,a,e);var o=p2.vec2.add([],i,a);this.drawSegment(i,t.bodyA.position,this.COLOR_S),this.drawSegment(r,t.bodyB.position,this.COLOR_S),this.drawVecAt(a,i,this.COLOR_BLACK),t.position>e&&this.drawSegment(r,o,this.COLOR_RED),this.drawCircle(i,3/this.factor,this.COLOR_BLACK),this.drawCircle(o,3/this.factor,this.COLOR_BLACK),t.lowerLimitEnabled&&(p2.vec2.normalize(a,a),p2.vec2.scale(a,a,t.lowerLimit),o=p2.vec2.add([],i,a),this.drawCircle(o,2/this.factor,this.COLOR_BLACK))},i.drawRevoluteJoint=function(t){var e=new Array,i=new Array;t.bodyA.toWorldFrame(e,t.pivotA),t.bodyB.toWorldFrame(i,t.pivotB),this.drawSegment(t.bodyA.position,e,this.COLOR_S),this.drawSegment(t.bodyB.position,i,this.COLOR_S),this.drawSegment(e,i,this.COLOR_RED),this.drawCircle(e,3/this.factor,this.COLOR_BLACK)},i.drawGearJoint=function(t){var e=t.bodyA.position,i=t.bodyB.position,r=new Array,a=new Array;t.bodyA.toWorldFrame(r,[20/this.factor,0]),t.bodyB.toWorldFrame(a,[20/this.factor,0]);var o=p2.vec2.subtract([],e,r),s=p2.vec2.subtract([],i,a);this.drawVecAt(o,e,this.COLOR_BLACK,!0),this.drawVecAt(s,i,this.COLOR_BLACK,!0),t.bodyB.toWorldFrame(s,[10*(t.bodyB.angle-t.bodyA.angle-t.angle)/this.factor,0]),this.drawSegment(s,i,this.COLOR_RED)},i.drawPrismaticJoint=function(t){var e=(t.bodyA.position,t.bodyB.position,new Array),i=new Array;t.bodyA.toWorldFrame(e,t.localAnchorA),t.bodyB.toWorldFrame(i,t.localAnchorB);var r=new Array;r=this.toWorldVector(t.localAxisA,t.bodyA);var a=p2.vec2.copy([],r),o=p2.vec2.copy([],r);t.lowerLimitEnabled?p2.vec2.scale(a,r,t.lowerLimit):p2.vec2.scale(a,r,5e3),t.upperLimitEnabled?p2.vec2.scale(o,r,t.upperLimit):p2.vec2.scale(o,r,5e3),this.drawVecAt(a,e,this.COLOR_BLACK,!0),this.drawVecAt(o,e,this.COLOR_BLACK,!0),p2.vec2.add(a,a,e),this.drawCircle(a,2/this.factor,this.COLOR_BLACK,1,!0),p2.vec2.add(o,o,e),this.drawCircle(o,2/this.factor,this.COLOR_BLACK,1,!0)},i.drawLockJoint=function(t){var e=new Array;new Array;t.bodyA.toWorldFrame(e,t.localOffsetB),this.drawSegment(e,t.bodyA.position,this.COLOR_S),this.drawSegment(e,t.bodyB.position,this.COLOR_RED),this.drawCircle(e,3/this.factor,this.COLOR_BLACK);var i=new Array;t.bodyA.toWorldFrame(i,[20/this.factor,0]),this.drawSegment(i,t.bodyA.position,this.COLOR_BLACK),t.bodyB.toWorldFrame(i,[20/this.factor,0]),this.drawSegment(i,t.bodyB.position,this.COLOR_BLACK)},i.drawLinearSpring=function(t){var e=new Array,i=new Array;t.bodyA.toWorldFrame(e,t.localAnchorA),t.bodyB.toWorldFrame(i,t.localAnchorB);var r=p2.vec2.subtract([],i,e);p2.vec2.normalize(r,r),p2.vec2.scale(r,r,t.restLength);var a=p2.vec2.add([],t.bodyA.position,r);this.drawSegment(a,t.bodyB.position,this.COLOR_RED),this.drawVecAt(r,e,this.COLOR_BLACK),this.drawCircle(e,3/this.factor,this.COLOR_RED),this.drawCircle(a,3/this.factor,this.COLOR_RED)},i.drawRotationalSpring=function(t){var e=new Array,i=new Array;e=t.bodyA.position,i=t.bodyB.position;var r=new Array,a=new Array;t.bodyA.toWorldFrame(r,[20/this.factor,0]),t.bodyB.toWorldFrame(a,[10*(t.bodyB.angle-t.bodyA.angle-t.restAngle+2)/this.factor,0]);var o=p2.vec2.subtract([],r,e),s=p2.vec2.subtract([],a,i);this.drawVecAt(o,e,this.COLOR_RED,!0),this.drawVecAt(s,i,this.COLOR_RED,!0),t.bodyB.toWorldFrame(a,[20/this.factor,0]),this.drawCircle(r,2/this.factor,this.COLOR_RED),this.drawCircle(a,2/this.factor,this.COLOR_RED)},i.drawShape=function(t,e,i,r){var i=void 0==i?this.getColor(e):i,r=void 0==r?!0:r;t instanceof p2.Convex?this.drawConvexShape(t,e,i,r):t instanceof p2.Plane?this.drawPlaneShape(t,e,i,r):t instanceof p2.Circle?this.drawCircleShape(t,e,i,r):t instanceof p2.Capsule?this.drawCapsule(t,e,i):t instanceof p2.Particle?this.drawParticle(t,e,i):t instanceof p2.Line?this.drawLine(t,e,i):t instanceof p2.Heightfield&&this.drawHeightfeild(t,e,i)},i.drawConvexShape=function(t,e,i,r){var a=(e.shapes.indexOf(t),t.position),o=t.angle,s=[],n=this.transformVec(t.vertices[0],a,o);e.toWorldFrame(s,a),e.toWorldFrame(n,n),this.drawSegment(s,n,i);for(var h=new Array,d=t.vertices.length,c=0;d>c;c++)n=this.transformVec(t.vertices[c],a,o),e.toWorldFrame(n,n),h.push(n);this.drawConvex(h,i,.5,r)},i.drawParticle=function(t,e,i){this.drawCircle(e.position,1/this.factor,i,.5),this.drawCircle(e.position,5/this.factor,i,1,!1)},i.drawLine=function(t,e,i){var r=t.length,a=new Array,o=new Array;e.toWorldFrame(a,[-r/2,0]),e.toWorldFrame(o,[r/2,0]),this.drawSegment(a,o,i)},i.drawHeightfeild=function(t,e,i){var r=this.sprite.graphics;r.lineStyle(1,i),r.beginFill(i,.5);var a,o=t.heights,s=t.elementWidth,n=new Array,h=new Array;o.forEach(function(t,i){a=i*s,n=new Array,e.toWorldFrame(n,[a,t]),h.push(n)}),n=new Array,e.toWorldFrame(n,[a,-500]),h.push(n),n=new Array,e.toWorldFrame(n,[0,-500]),h.push(n),n=new Array,e.toWorldFrame(n,[0,0]),h.push(n),this.drawConvex(h,i,.5)},i.drawCapsule=function(t,e,i){var r=t.length,a=t.radius,o=new Array,s=new Array,n=new Array,h=new Array,d=new Array,c=new Array;e.toWorldFrame(o,[-r/2,-a]),e.toWorldFrame(s,[r/2,-a]),e.toWorldFrame(n,[r/2,a]),e.toWorldFrame(h,[-r/2,a]),e.toWorldFrame(d,[r/2,0]),e.toWorldFrame(c,[-r/2,0]),this.drawCircle(d,a,i,.5),this.drawCircle(c,a,i,.5),this.drawConvex([o,s,n,h],i,.5)},i.drawCircleShape=function(t,e,i,r){var a=t.position,o=t.angle,s=new Array;e.toWorldFrame(s,a),this.drawCircle(s,t.radius,i,.5,r);var n=this.transformVec([t.radius,0],a,o);e.toWorldFrame(n,n),this.drawSegment(s,n,i)},i.drawPlaneShape=function(t,e,i,r){var a=new Array,o=new Array;e.shapes.indexOf(t);e.toWorldFrame(a,[1e3,0]),a=this.transformVec(a,t.position,t.angle),o.push(a),a=new Array,e.toWorldFrame(a,[1e3,-1e5]),a=this.transformVec(a,t.position,t.angle),o.push(a),a=new Array,e.toWorldFrame(a,[-1e3,-1e5]),a=this.transformVec(a,t.position,t.angle),o.push(a),a=new Array,e.toWorldFrame(a,[-1e3,0]),a=this.transformVec(a,t.position,t.angle),o.push(a),this.drawConvex(o,i,.5,r)},i.getColor=function(t){var e=this.COLOR_D_SLEEP;return t.type==p2.Body.KINEMATIC?e=this.COLOR_K:t.type==p2.Body.STATIC?e=this.COLOR_S:t.sleepState==p2.Body.AWAKE&&(e=this.COLOR_D_WAKE),e},i.drawVecAt=function(t,e,i,r){void 0===r&&(r=!1);var a=p2.vec2.copy([],e),o=p2.vec2.add([],t,e);r&&this.drawCircle(a,3/this.factor,i),this.drawSegment(a,o,i)},i.drawVecTo=function(t,e,i,r){void 0===r&&(r=!1);var a=p2.vec2.copy([],e),o=p2.vec2.subtract([],e,t);r&&this.drawCircle(a,3/this.factor,i),this.drawSegment(a,o,i)},i.drawSegment=function(t,e,i){this.sprite.graphics.lineStyle(1,i),this.sprite.graphics.moveTo(t[0]*this.factor,t[1]*this.factor),this.sprite.graphics.lineTo(e[0]*this.factor,e[1]*this.factor)},i.drawCircle=function(t,e,i,r,a){void 0===r&&(r=1),this.sprite.graphics.lineStyle(1,i),(a||void 0==a)&&this.sprite.graphics.beginFill(i,r),this.sprite.graphics.drawCircle(t[0]*this.factor,t[1]*this.factor,e*this.factor),this.sprite.graphics.endFill()},i.drawConvex=function(t,e,i,r){void 0===i&&(i=1),void 0===r&&(r=!0),this.sprite.graphics.lineStyle(1,e),r&&this.sprite.graphics.beginFill(e,i);var a=t.length,o=t[0];this.sprite.graphics.moveTo(o[0]*this.factor,o[1]*this.factor);for(var s=1;a>=s;s++)o=t[s%a],this.sprite.graphics.lineTo(o[0]*this.factor,o[1]*this.factor);this.sprite.graphics.endFill()},i.toWorldVector=function(t,e){var i=new Array;return p2.vec2.rotate(i,t,e.angle),i},i.transformVec=function(t,e,i){var r=new Array;return p2.vec2.rotate(r,t,i),p2.vec2.add(r,r,e),r},i.drawDotLine=function(t,e,i,r){if(void 0===e&&(e=0),void 0===i&&(i=!1),void 0===r&&(r=30),!(t.length<2)){var a=2/this.factor,o=[];p2.vec2.copy(o,t[0]),this.drawCircle(o,a,e,1,!1);for(var s=0;s<t.length-2;s++){var n=t[s];if(i)for(var h=p2.vec2.distance(o,n);h>r/this.factor;){var d=[];p2.vec2.subtract(d,n,o),p2.vec2.scale(d,d,r/this.factor/h),p2.vec2.add(o,o,d),this.drawCircle(o,a,e,1,!1),h=p2.vec2.distance(o,n)}else this.drawCircle(n,a,e,1,!1)}}},t}();egret.registerClass(p2DebugDraw,"p2DebugDraw");